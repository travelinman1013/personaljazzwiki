# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Jazzapedia is a Wikipedia-style encyclopedia for 4,000+ musician profiles. Built with Astro in SSR mode, it serves pages dynamically from a Cloudflare D1 database.

**Live Site:** https://jazzapedia.com

**Stats:** 4,015 artists, 456 genres, 148 instruments

## Architecture

### Server-Side Rendering (SSR)

The site uses Astro with `output: 'server'` and the `@astrojs/cloudflare` adapter. All pages query the D1 database at request time rather than being pre-built.

### Cloudflare Stack

- **Pages**: Hosts the Astro SSR application
- **D1**: SQLite database storing all artist data
- **R2**: Object storage for artist portraits at `media.jazzapedia.com`

### Database Access

Pages access D1 via runtime bindings:
```typescript
const db = Astro.locals.runtime?.env?.DB;
const result = await db.prepare('SELECT * FROM artists WHERE slug = ?').bind(slug).first();
```

### Key Files

- `wrangler.toml` - D1 binding config (must have `pages_build_output_dir` for Pages)
- `astro.config.mjs` - SSR config with Cloudflare adapter
- `src/pages/` - All route handlers querying D1
- `src/components/Infobox.astro` - Wikipedia-style sidebar with artist metadata

## Commands

```bash
npm run dev          # Start dev server (uses LOCAL D1 database)
npm run build        # Build SSR bundle to ./dist/
npm run preview      # Preview built site
```

For deployment:
```bash
npm run build
npx pagefind --site dist
npx wrangler pages deploy dist --project-name jazzapedia
```

## Database Schema

### artists table
```sql
CREATE TABLE artists (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  slug TEXT UNIQUE NOT NULL,
  title TEXT NOT NULL,
  artist_type TEXT,              -- 'person' or 'band'
  birth_date TEXT,
  death_date TEXT,
  origin TEXT,                   -- Location for bands
  birth_place TEXT,              -- Birth location for individuals
  bio_html TEXT,                 -- Rendered HTML content
  bio_markdown TEXT,             -- Original markdown
  image_filename TEXT,
  genres TEXT DEFAULT '[]',           -- JSON array
  instruments TEXT DEFAULT '[]',      -- JSON array
  roles TEXT DEFAULT '[]',            -- JSON array
  spotify_data TEXT DEFAULT '{}',     -- JSON object
  audio_profile TEXT DEFAULT '{}',    -- JSON object
  musical_connections TEXT DEFAULT '{}',  -- JSON object
  external_urls TEXT DEFAULT '{}',    -- JSON object
  social_links TEXT DEFAULT '{}',     -- JSON object
  discography_summary TEXT DEFAULT '{}', -- JSON object
  research_sources TEXT DEFAULT '[]', -- JSON array of Perplexity source URLs
  career_span TEXT,
  is_active INTEGER DEFAULT 1,
  primary_role TEXT,
  created_at TEXT,
  updated_at TEXT
);
```

### genres / instruments / roles tables
```sql
CREATE TABLE genres (
  id INTEGER PRIMARY KEY,
  name TEXT UNIQUE NOT NULL,
  slug TEXT UNIQUE NOT NULL,
  artist_count INTEGER DEFAULT 0
);
-- Same structure for instruments and roles tables
```

## Local Development

### Local vs Remote D1

The dev server uses a **local D1 database** stored in `.wrangler/state/v3/d1/`. This is completely separate from production.

```bash
npm run dev  # Connects to LOCAL D1 (not production)
```

### Syncing Data to Local D1

To populate or update your local database:
```bash
# Sync artist markdown files to local D1
npx tsx scripts/sync-to-d1.ts --local

# Or sync to production
npx tsx scripts/sync-to-d1.ts --remote
```

### Running Migrations

```bash
# Apply to local D1
npx wrangler d1 execute jazzapedia --file=migrations/XXX.sql --local

# Apply to production D1
npx wrangler d1 execute jazzapedia --file=migrations/XXX.sql --remote
```

## Data Pipeline

### Source Data

Artist markdown files live in an Obsidian vault at:
```
/Users/maxwell/LETSGO/MaxVault/01_Projects/PersonalArtistWiki/Artists/
```

These are generated by the artist discovery pipeline (`/Users/maxwell/Projects/wwoz-scraper-v3/artist_discovery_pipeline.py`) which uses Spotify, MusicBrainz, and Perplexity AI for research.

### Sync Script (`scripts/sync-to-d1.ts`)

Reads markdown files, parses frontmatter, converts to HTML, and batch-inserts into D1:

```bash
npx tsx scripts/sync-to-d1.ts --local          # Sync to local D1
npx tsx scripts/sync-to-d1.ts --remote         # Sync to production D1
npx tsx scripts/sync-to-d1.ts --remote --dry-run  # Preview without changes
```

The script:
- Parses YAML frontmatter for metadata
- Converts markdown body to HTML
- Finds matching portrait images
- Generates SQL batches in `./sync-output/`
- Executes against D1

### Backfill Script (`scripts/backfill-origin-sources.ts`)

Extracts data from existing `bio_html` to populate new columns:

```bash
npx tsx scripts/backfill-origin-sources.ts --local --dry-run  # Preview
npx tsx scripts/backfill-origin-sources.ts --local            # Execute
npx tsx scripts/backfill-origin-sources.ts --remote           # Production
```

## Page Patterns

### Artist Pages (`src/pages/artists/[...slug].astro`)

- Fetches artist from D1 by slug
- Parses JSON fields (genres, instruments, spotify_data, etc.)
- Strips redundant Quick Info section from bio_html
- Extracts research sources for References section
- Renders Infobox, bio content, WWOZ plays, and Connection Graph

### Infobox Component

The infobox displays differently for bands vs individuals:
- **Bands**: Shows "Formed" date + "Origin" location, "Group" badge
- **Individuals**: Shows "Born" date + birthPlace, "Artist" badge

### References Section

Perplexity research sources are displayed as a numbered list before the Connection Graph. Sources are either:
1. Stored in `research_sources` column (preferred)
2. Extracted from `bio_html` as fallback (legacy)

## Image URLs

Portraits are served from R2:
```typescript
const portraitUrl = `https://media.jazzapedia.com/portraits/${artist.image_filename}`;
```

## Caching

Pages set cache headers for edge caching:
```typescript
Astro.response.headers.set('Cache-Control', 'public, max-age=60, stale-while-revalidate=86400');
```

## Deployment

GitHub Actions workflow (`.github/workflows/deploy.yml`) runs on push to master:
1. `npm ci` - Install dependencies
2. `npm run build` - Build Astro SSR bundle
3. `npx pagefind --site dist` - Generate search index
4. `npx wrangler pages deploy dist --project-name jazzapedia` - Deploy with D1 binding

**Note:** Code deploys automatically, but database migrations and data syncs must be run manually.

## Common Tasks

### Adding a new page
1. Create `.astro` file in `src/pages/`
2. Access D1 via `Astro.locals.runtime?.env?.DB`
3. Set appropriate cache headers
4. Handle `db` being undefined gracefully

### Modifying database schema
1. Create migration in `migrations/`
2. Apply locally: `npx wrangler d1 execute jazzapedia --file=migrations/XXX.sql --local`
3. Test with `npm run dev`
4. Apply to production: `npx wrangler d1 execute jazzapedia --file=migrations/XXX.sql --remote`

### Full data refresh
```bash
# 1. Run pipeline to generate/update artist cards (separate repo)
# 2. Sync to D1
npx tsx scripts/sync-to-d1.ts --remote
# 3. Deploy code if changed
npm run build && npx wrangler pages deploy dist --project-name jazzapedia
```

### Updating wrangler.toml
- Keep `pages_build_output_dir = "dist"` - required for D1 bindings
- D1 binding must use `binding = "DB"` to match code expectations

## Spotify Metadata Enrichment

A local Spotify database (Anna's Archive dump) is available for enriching artist data:

**Database Location:** `/Volumes/the-eagle/spotify_metadata/annas_archive_spotify_2025_07_metadata/`

See `~/.claude/skills/spotify-metadata.md` for full database schema and query examples.
