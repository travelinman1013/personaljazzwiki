---
interface Props {
  title: string;
  data: Record<string, unknown>;
}

const { title, data } = Astro.props;

// Extract infobox data
const infobox = data.infobox as Record<string, unknown> | undefined;
const spotifyData = data.spotify_data as { popularity?: number; followers?: number; url?: string; id?: string } | undefined;

// Determine background color based on artist type
const getBackgroundColor = (background?: string) => {
  switch (background) {
    case 'solo_singer':
      return 'bg-amber-50 border-amber-200';
    case 'instrumentalist':
      return 'bg-blue-50 border-blue-200';
    case 'group_or_band':
      return 'bg-green-50 border-green-200';
    default:
      return 'bg-wiki-bg-infobox border-wiki-border-infobox';
  }
};

const getHeaderColor = (background?: string) => {
  switch (background) {
    case 'solo_singer':
      return 'bg-amber-200 text-amber-900';
    case 'instrumentalist':
      return 'bg-blue-200 text-blue-900';
    case 'group_or_band':
      return 'bg-green-200 text-green-900';
    default:
      return 'bg-wiki-bg-nav text-wiki-text';
  }
};

const background = infobox?.background as string | undefined;
const boxColor = getBackgroundColor(background);
const headerColor = getHeaderColor(background);

// Format numbers with commas
const formatNumber = (num: number | undefined) => num?.toLocaleString() ?? 'N/A';

// Format date for display
const formatDate = (date: string | undefined) => {
  if (!date) return null;
  try {
    const d = new Date(date);
    return d.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
  } catch {
    return date;
  }
};

// Extract key data with fallbacks
const birthName = (data.birth_name || infobox?.birth_name) as string | undefined;
const birthDate = (data.birth_date || infobox?.born) as string | undefined;
const birthPlace = data.birth_place as string | undefined;
const deathDate = (data.death_date || infobox?.died) as string | undefined;
const genres = (data.genres || []) as string[];
const instruments = (data.instruments || []) as string[];
const yearsActive = data.years_active as string | undefined;
const occupation = (data.occupation || []) as string[];
const recordLabels = (data.record_labels || []) as string[];
const aliases = (data.aliases || data.also_known_as || []) as string[];
const spouse = (data.spouse || []) as string[];
const associatedActs = (data.associated_acts || []) as string[];

// Get image path - extract just the filename from the path
const rawImagePath = (data.image_path || infobox?.image) as string | undefined;
let portraitFilename: string | undefined;
if (rawImagePath) {
  // Extract just the filename from paths like "03_Resources/source_material/ArtistPortraits/Louis_Armstrong.jpg"
  portraitFilename = rawImagePath.split('/').pop();
}

// External URLs
const externalUrls = data.external_urls as { spotify?: string; wikipedia?: string; musicbrainz?: string } | undefined;

// Helper to convert genre/instrument to slug
const toSlug = (text: string) => text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
---

<aside class={`infobox float-right w-72 ml-6 mb-4 border rounded ${boxColor}`}>
  <!-- Header -->
  <div class={`${headerColor} px-3 py-2 font-serif text-lg font-semibold text-center border-b`}>
    {title}
  </div>

  <!-- Image -->
  {portraitFilename ? (
    <div class="border-b overflow-hidden portrait-container">
      <img
        src={`/portraits/${portraitFilename}`}
        alt={title}
        class="w-full h-auto object-cover portrait-image"
        loading="lazy"
      />
      <div class="portrait-fallback hidden bg-gray-100 aspect-[3/4] flex items-center justify-center text-gray-400">
        <div class="text-center p-4">
          <svg class="w-16 h-16 mx-auto mb-2 text-gray-300" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
          </svg>
          <span class="text-sm">No image available</span>
        </div>
      </div>
    </div>
  ) : (
    <div class="bg-gray-100 aspect-[3/4] flex items-center justify-center text-gray-400 border-b">
      <div class="text-center p-4">
        <svg class="w-16 h-16 mx-auto mb-2 text-gray-300" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
        </svg>
        <span class="text-sm">No image available</span>
      </div>
    </div>
  )}

  <!-- Info Table -->
  <table class="w-full text-sm">
    <tbody>
      {birthName && (
        <tr class="border-b border-wiki-border-light">
          <th class="px-2 py-1.5 text-left font-semibold bg-wiki-bg-nav w-24 align-top">Birth name</th>
          <td class="px-2 py-1.5">{birthName}</td>
        </tr>
      )}

      {aliases.length > 0 && (
        <tr class="border-b border-wiki-border-light">
          <th class="px-2 py-1.5 text-left font-semibold bg-wiki-bg-nav w-24 align-top">Also known as</th>
          <td class="px-2 py-1.5">{aliases.slice(0, 3).join(', ')}{aliases.length > 3 ? '...' : ''}</td>
        </tr>
      )}

      {birthDate && (
        <tr class="border-b border-wiki-border-light">
          <th class="px-2 py-1.5 text-left font-semibold bg-wiki-bg-nav w-24 align-top">Born</th>
          <td class="px-2 py-1.5">
            {formatDate(birthDate)}
            {birthPlace && <><br /><span class="text-wiki-text-muted">{birthPlace}</span></>}
          </td>
        </tr>
      )}

      {deathDate && (
        <tr class="border-b border-wiki-border-light">
          <th class="px-2 py-1.5 text-left font-semibold bg-wiki-bg-nav w-24 align-top">Died</th>
          <td class="px-2 py-1.5">{formatDate(deathDate)}</td>
        </tr>
      )}

      {genres.length > 0 && (
        <tr class="border-b border-wiki-border-light">
          <th class="px-2 py-1.5 text-left font-semibold bg-wiki-bg-nav w-24 align-top">Genres</th>
          <td class="px-2 py-1.5">
            <div class="flex flex-wrap gap-1">
              {genres.slice(0, 5).map(genre => (
                <a href={`/genres/${toSlug(genre)}`} class="text-wiki-link hover:underline">{genre}</a>
              ))}
              {genres.length > 5 && <span class="text-wiki-text-muted">+{genres.length - 5} more</span>}
            </div>
          </td>
        </tr>
      )}

      {instruments.length > 0 && (
        <tr class="border-b border-wiki-border-light">
          <th class="px-2 py-1.5 text-left font-semibold bg-wiki-bg-nav w-24 align-top">Instruments</th>
          <td class="px-2 py-1.5">
            <div class="flex flex-wrap gap-1">
              {instruments.slice(0, 4).map(instrument => (
                <a href={`/instruments/${toSlug(instrument)}`} class="text-wiki-link hover:underline">{instrument}</a>
              ))}
              {instruments.length > 4 && <span class="text-wiki-text-muted">+{instruments.length - 4} more</span>}
            </div>
          </td>
        </tr>
      )}

      {occupation.length > 0 && (
        <tr class="border-b border-wiki-border-light">
          <th class="px-2 py-1.5 text-left font-semibold bg-wiki-bg-nav w-24 align-top">Occupation</th>
          <td class="px-2 py-1.5">{occupation.slice(0, 3).join(', ')}</td>
        </tr>
      )}

      {yearsActive && (
        <tr class="border-b border-wiki-border-light">
          <th class="px-2 py-1.5 text-left font-semibold bg-wiki-bg-nav w-24 align-top">Years active</th>
          <td class="px-2 py-1.5">{yearsActive}</td>
        </tr>
      )}

      {recordLabels.length > 0 && (
        <tr class="border-b border-wiki-border-light">
          <th class="px-2 py-1.5 text-left font-semibold bg-wiki-bg-nav w-24 align-top">Labels</th>
          <td class="px-2 py-1.5">{recordLabels.slice(0, 3).join(', ')}{recordLabels.length > 3 ? '...' : ''}</td>
        </tr>
      )}

      {associatedActs.length > 0 && (
        <tr class="border-b border-wiki-border-light">
          <th class="px-2 py-1.5 text-left font-semibold bg-wiki-bg-nav w-24 align-top">Associated acts</th>
          <td class="px-2 py-1.5">{associatedActs.slice(0, 3).join(', ')}{associatedActs.length > 3 ? '...' : ''}</td>
        </tr>
      )}

      {spouse.length > 0 && (
        <tr class="border-b border-wiki-border-light">
          <th class="px-2 py-1.5 text-left font-semibold bg-wiki-bg-nav w-24 align-top">Spouse(s)</th>
          <td class="px-2 py-1.5">{spouse.join(', ')}</td>
        </tr>
      )}

      <!-- Spotify Section -->
      {spotifyData && (spotifyData.popularity || spotifyData.followers) && (
        <>
          <tr class="bg-green-50">
            <th colspan="2" class="px-2 py-1.5 text-center font-semibold text-green-800 border-b border-wiki-border-light">
              <svg class="inline-block w-4 h-4 mr-1 -mt-0.5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/>
              </svg>
              Spotify Stats
            </th>
          </tr>
          {spotifyData.popularity !== undefined && (
            <tr class="border-b border-wiki-border-light">
              <th class="px-2 py-1.5 text-left font-semibold bg-wiki-bg-nav w-24">Popularity</th>
              <td class="px-2 py-1.5">
                <div class="flex items-center gap-2">
                  <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                    <div class="h-full bg-green-500 rounded-full" style={`width: ${spotifyData.popularity}%`}></div>
                  </div>
                  <span class="text-xs font-medium">{spotifyData.popularity}/100</span>
                </div>
              </td>
            </tr>
          )}
          {spotifyData.followers && (
            <tr class="border-b border-wiki-border-light">
              <th class="px-2 py-1.5 text-left font-semibold bg-wiki-bg-nav w-24">Followers</th>
              <td class="px-2 py-1.5">{formatNumber(spotifyData.followers)}</td>
            </tr>
          )}
          {spotifyData.url && (
            <tr class="border-b border-wiki-border-light">
              <th class="px-2 py-1.5 text-left font-semibold bg-wiki-bg-nav w-24">Listen</th>
              <td class="px-2 py-1.5">
                <a href={spotifyData.url} target="_blank" rel="noopener noreferrer" class="text-green-600 hover:underline">
                  Open in Spotify
                </a>
              </td>
            </tr>
          )}
        </>
      )}

      <!-- External Links -->
      {externalUrls && (externalUrls.wikipedia || externalUrls.musicbrainz) && (
        <>
          <tr class="bg-wiki-bg-nav">
            <th colspan="2" class="px-2 py-1.5 text-center font-semibold border-b border-wiki-border-light">
              External Links
            </th>
          </tr>
          <tr class="border-b border-wiki-border-light">
            <td colspan="2" class="px-2 py-1.5">
              <div class="flex flex-wrap gap-3 text-xs">
                {externalUrls.wikipedia && (
                  <a href={externalUrls.wikipedia} target="_blank" rel="noopener noreferrer" class="text-wiki-link hover:underline">
                    Wikipedia
                  </a>
                )}
                {externalUrls.musicbrainz && (
                  <a href={externalUrls.musicbrainz} target="_blank" rel="noopener noreferrer" class="text-wiki-link hover:underline">
                    MusicBrainz
                  </a>
                )}
              </div>
            </td>
          </tr>
        </>
      )}
    </tbody>
  </table>
</aside>

<style>
  .infobox {
    font-size: 0.875rem;
    line-height: 1.4;
  }

  .infobox th {
    vertical-align: top;
  }

  .infobox td {
    word-break: break-word;
  }

  /* Responsive: stack on mobile */
  @media (max-width: 640px) {
    .infobox {
      float: none;
      width: 100%;
      margin-left: 0;
      margin-bottom: 1rem;
    }
  }
</style>

<script>
  // Handle portrait image loading errors
  document.addEventListener('DOMContentLoaded', () => {
    const portraitImages = document.querySelectorAll('.portrait-image');
    portraitImages.forEach(img => {
      img.addEventListener('error', () => {
        const container = img.closest('.portrait-container');
        if (container) {
          const fallback = container.querySelector('.portrait-fallback');
          if (fallback) {
            img.style.display = 'none';
            fallback.classList.remove('hidden');
          }
        }
      });
    });
  });
</script>
