---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { ArtistMatcher, toArtistSlug } from '../../lib/artist-matcher';

export async function getStaticPaths() {
  const wwozLogs = await getCollection('wwoz');
  return wwozLogs.map(log => ({
    params: { date: log.id },
    props: { log },
  }));
}

const { log } = Astro.props;
const { date, stats, tracks } = log.data;

// Build artist matcher
const artists = await getCollection('artists');
const artistEntries = artists.map(a => ({
  id: a.id,
  name: (a.data.title as string) ?? a.id,
}));
const matcher = new ArtistMatcher(artistEntries);

// Format date for display
const formatDateFull = (dateStr: string) => {
  const d = new Date(dateStr + 'T12:00:00');
  const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  const months = ['January', 'February', 'March', 'April', 'May', 'June',
                  'July', 'August', 'September', 'October', 'November', 'December'];
  return `${days[d.getDay()]}, ${months[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`;
};

// Group tracks by show
const tracksByShow = new Map<string, typeof tracks>();
tracks?.forEach(track => {
  const show = track.show || 'Unknown Show';
  if (!tracksByShow.has(show)) {
    tracksByShow.set(show, []);
  }
  tracksByShow.get(show)!.push(track);
});

// Calculate match rate
const matchRate = stats && stats.totalTracks > 0
  ? ((stats.successfullyFound / stats.totalTracks) * 100).toFixed(1)
  : '0';

// Wiki artist match helper
interface MatchedArtist {
  name: string;
  slug: string | null;
  isMatched: boolean;
}

const matchArtist = (artistName: string): MatchedArtist => {
  const match = matcher.match(artistName);
  if (match && match.score >= 0.7) {
    return {
      name: artistName,
      slug: match.artist.id,
      isMatched: true,
    };
  }
  return {
    name: artistName,
    slug: null,
    isMatched: false,
  };
};
---

<Layout title={`WWOZ - ${formatDateFull(date)}`}>
  <div class="article-content">
    <!-- Back link -->
    <a href="/wwoz" class="inline-flex items-center text-wiki-link hover:text-wiki-link-hover text-sm mb-4">
      <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      Back to Archive
    </a>

    <h1>WWOZ - {formatDateFull(date)}</h1>

    <!-- Stats Summary -->
    {stats && (
      <div class="bg-wiki-accent-light border border-wiki-border rounded-lg p-4 mb-6">
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-center">
          <div>
            <div class="text-xl font-bold text-wiki-text-heading">{stats.totalTracks}</div>
            <div class="text-xs text-wiki-text-muted">Total Tracks</div>
          </div>
          <div>
            <div class="text-xl font-bold text-green-600">{stats.successfullyFound}</div>
            <div class="text-xs text-wiki-text-muted">Found</div>
          </div>
          <div>
            <div class="text-xl font-bold text-red-400">{stats.notFound}</div>
            <div class="text-xs text-wiki-text-muted">Not Found</div>
          </div>
          <div>
            <div class="text-xl font-bold text-jazz-amber">{stats.lowConfidence}</div>
            <div class="text-xs text-wiki-text-muted">Low Confidence</div>
          </div>
          <div>
            <div class="text-xl font-bold text-wiki-text-heading">{matchRate}%</div>
            <div class="text-xs text-wiki-text-muted">Match Rate</div>
          </div>
        </div>
      </div>
    )}

    <!-- Navigation between days -->
    <div class="flex justify-between items-center mb-6 text-sm">
      <span class="text-wiki-text-muted">Navigate:</span>
      <div class="flex gap-4">
        <a href="/wwoz" class="text-wiki-link hover:underline">Archive Index</a>
      </div>
    </div>

    <!-- Tracks by Show -->
    <div class="space-y-8">
      {Array.from(tracksByShow.entries()).map(([show, showTracks]) => {
        const showMatched = showTracks.filter(t => t.status === 'found').length;
        const showTotal = showTracks.length;
        const showRate = ((showMatched / showTotal) * 100).toFixed(0);
        const host = showTracks[0]?.host;

        return (
          <section>
            <h2 class="text-lg font-serif border-b border-wiki-border pb-2 mb-3 flex items-center justify-between">
              <span>
                {show}
                {host && host !== '-' && (
                  <span class="text-wiki-text-muted font-normal text-sm ml-2">
                    with {host}
                  </span>
                )}
              </span>
              <span class="text-sm font-normal text-wiki-text-muted">
                {showMatched}/{showTotal} matched ({showRate}%)
              </span>
            </h2>

            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead>
                  <tr class="text-left text-wiki-text-muted border-b border-wiki-border">
                    <th class="py-2 px-2 w-16">Time</th>
                    <th class="py-2 px-2">Artist</th>
                    <th class="py-2 px-2">Title</th>
                    <th class="py-2 px-2 hidden md:table-cell">Album</th>
                    <th class="py-2 px-2 hidden lg:table-cell">Genres</th>
                    <th class="py-2 px-2 w-20 text-center">Status</th>
                    <th class="py-2 px-2 w-16 text-center">Link</th>
                  </tr>
                </thead>
                <tbody>
                  {showTracks.map(track => {
                    const artistMatch = matchArtist(track.artist);
                    const isFound = track.status === 'found';
                    const confidence = track.confidence;
                    const isLowConf = confidence !== undefined && confidence < 80;

                    return (
                      <tr class="border-b border-wiki-border-light hover:bg-wiki-accent-light transition-colors">
                        <td class="py-2 px-2 text-wiki-text-muted font-mono text-xs">
                          {track.time}
                        </td>
                        <td class="py-2 px-2">
                          {artistMatch.isMatched ? (
                            <a
                              href={`/artists/${artistMatch.slug}`}
                              class="text-wiki-link hover:underline font-medium"
                            >
                              {track.artist}
                            </a>
                          ) : (
                            <span class="text-wiki-text">{track.artist}</span>
                          )}
                        </td>
                        <td class="py-2 px-2 text-wiki-text">{track.title}</td>
                        <td class="py-2 px-2 text-wiki-text-muted hidden md:table-cell">
                          {track.album || '-'}
                        </td>
                        <td class="py-2 px-2 hidden lg:table-cell">
                          {track.genres.length > 0 ? (
                            <div class="flex flex-wrap gap-1">
                              {track.genres.slice(0, 3).map(genre => (
                                <span class="inline-block px-1.5 py-0.5 bg-wiki-bg border border-wiki-border rounded text-xs text-wiki-text-muted">
                                  {genre}
                                </span>
                              ))}
                              {track.genres.length > 3 && (
                                <span class="text-xs text-wiki-text-muted">+{track.genres.length - 3}</span>
                              )}
                            </div>
                          ) : (
                            <span class="text-wiki-text-muted">-</span>
                          )}
                        </td>
                        <td class="py-2 px-2 text-center">
                          {isFound ? (
                            <span class={`inline-flex items-center ${isLowConf ? 'text-jazz-amber' : 'text-green-500'}`}>
                              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                              </svg>
                              {confidence !== undefined && (
                                <span class="text-xs ml-1">{confidence.toFixed(0)}%</span>
                              )}
                            </span>
                          ) : (
                            <span class="text-red-400">
                              <svg class="w-4 h-4 inline" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                              </svg>
                            </span>
                          )}
                        </td>
                        <td class="py-2 px-2 text-center">
                          {track.spotifyUrl ? (
                            <a
                              href={track.spotifyUrl}
                              target="_blank"
                              rel="noopener noreferrer"
                              class="inline-flex items-center justify-center w-6 h-6 bg-[#1DB954] rounded-full hover:bg-[#1ed760] transition-colors"
                              title="Open in Spotify"
                            >
                              <svg class="w-3.5 h-3.5 text-white" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/>
                              </svg>
                            </a>
                          ) : (
                            <span class="text-wiki-text-muted">-</span>
                          )}
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </section>
        );
      })}
    </div>

    <!-- Footer -->
    <div class="mt-8 pt-4 border-t border-wiki-border text-sm text-wiki-text-muted">
      <p>
        Source: <a href="https://wwoz.org/programs/playlists" class="text-wiki-link hover:underline">WWOZ Playlists</a>.
        Artists are linked to wiki profiles when a match is found in the database.
      </p>
    </div>
  </div>
</Layout>

<style>
  /* Ensure table doesn't break layout on mobile */
  .overflow-x-auto {
    -webkit-overflow-scrolling: touch;
  }

  /* Zebra striping for table */
  tbody tr:nth-child(even) {
    background-color: var(--color-bg);
  }
</style>
