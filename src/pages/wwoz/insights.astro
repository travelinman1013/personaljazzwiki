---
/**
 * WWOZ Insights Dashboard
 * Aggregates statistics from all WWOZ daily logs
 * Shows top artists, genres, shows, and trends
 */
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { ArtistMatcher, toArtistSlug } from '../../lib/artist-matcher';

// Load collections
const wwozLogs = await getCollection('wwoz');
const artists = await getCollection('artists');

// Create artist matcher for linking to wiki profiles
const artistEntries = artists.map(a => ({
  id: a.id,
  name: a.data.title ?? a.id
}));
const matcher = new ArtistMatcher(artistEntries);

// Aggregate artist plays
const artistPlays = new Map<string, { name: string; slug?: string; count: number }>();

// Aggregate genre counts
const genreCounts = new Map<string, number>();

// Aggregate show counts
const showCounts = new Map<string, { name: string; trackCount: number }>();

// Track daily stats
let totalTracks = 0;
let totalFound = 0;
let totalNotFound = 0;

// Process all logs
for (const log of wwozLogs) {
  const tracks = log.data.tracks || [];
  const stats = log.data.stats;

  // Accumulate daily stats
  if (stats) {
    totalTracks += stats.totalTracks;
    totalFound += stats.successfullyFound;
    totalNotFound += stats.notFound;
  }

  for (const track of tracks) {
    // Artist aggregation
    const key = track.artist.toLowerCase();
    if (!artistPlays.has(key)) {
      const match = matcher.match(track.artist);
      artistPlays.set(key, {
        name: track.artist,
        slug: match?.artist.id,
        count: 0
      });
    }
    artistPlays.get(key)!.count++;

    // Genre aggregation
    for (const genre of track.genres) {
      genreCounts.set(genre, (genreCounts.get(genre) || 0) + 1);
    }

    // Show aggregation
    const showKey = track.show.toLowerCase();
    if (!showCounts.has(showKey)) {
      showCounts.set(showKey, { name: track.show, trackCount: 0 });
    }
    showCounts.get(showKey)!.trackCount++;
  }
}

// Sort and slice for display
const topArtists = Array.from(artistPlays.values())
  .sort((a, b) => b.count - a.count)
  .slice(0, 20);

const topGenres = Array.from(genreCounts.entries())
  .sort((a, b) => b[1] - a[1])
  .slice(0, 15);

const topShows = Array.from(showCounts.values())
  .sort((a, b) => b.trackCount - a.trackCount)
  .slice(0, 10);

// Calculate max for bar chart scaling
const maxArtistPlays = topArtists.length > 0 ? topArtists[0].count : 1;
const maxGenreCount = topGenres.length > 0 ? topGenres[0][1] : 1;

// Stats
const daysTracked = wwozLogs.length;
const uniqueArtists = artistPlays.size;
const uniqueGenres = genreCounts.size;
const matchRate = totalTracks > 0 ? ((totalFound / totalTracks) * 100).toFixed(1) : '0';

// Helper to create genre slug
const toGenreSlug = (genre: string) =>
  genre.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
---

<Layout title="WWOZ Insights">
  <div class="article-content">
    <!-- Header -->
    <div class="flex items-center gap-4 mb-2">
      <a href="/wwoz" class="text-wiki-link hover:text-wiki-link-hover text-sm">
        &larr; Back to WWOZ
      </a>
    </div>

    <h1 class="flex items-center gap-3">
      <span class="text-jazz-amber">&#128251;</span>
      WWOZ Insights
    </h1>

    <p class="text-wiki-text-secondary mb-8">
      Aggregated statistics from <strong class="text-jazz-amber">{daysTracked}</strong> days of WWOZ playlist tracking.
    </p>

    <!-- Summary Stats -->
    <section class="stats-grid mb-10">
      <div class="stat-card">
        <span class="stat-icon">&#128197;</span>
        <span class="stat-value">{daysTracked}</span>
        <span class="stat-label">Days Tracked</span>
      </div>
      <div class="stat-card">
        <span class="stat-icon">&#127925;</span>
        <span class="stat-value">{totalTracks.toLocaleString()}</span>
        <span class="stat-label">Total Tracks</span>
      </div>
      <div class="stat-card">
        <span class="stat-icon">&#127908;</span>
        <span class="stat-value">{uniqueArtists.toLocaleString()}</span>
        <span class="stat-label">Unique Artists</span>
      </div>
      <div class="stat-card">
        <span class="stat-icon">&#127926;</span>
        <span class="stat-value">{uniqueGenres}</span>
        <span class="stat-label">Genres</span>
      </div>
      <div class="stat-card">
        <span class="stat-icon">&#9989;</span>
        <span class="stat-value">{matchRate}%</span>
        <span class="stat-label">Match Rate</span>
      </div>
    </section>

    <!-- Top Artists -->
    <section class="mb-10">
      <h2 class="section-title">
        <span class="section-icon">&#127911;</span>
        Top Artists
      </h2>
      <p class="text-wiki-text-muted text-sm mb-4">
        Most played artists across all tracked days
      </p>

      <div class="artist-chart">
        {topArtists.map((artist, index) => {
          const barWidth = (artist.count / maxArtistPlays) * 100;
          return (
            <div class="artist-row">
              <span class="artist-rank">{index + 1}</span>
              <div class="artist-info">
                {artist.slug ? (
                  <a href={`/artists/${artist.slug}`} class="artist-name wiki-link">
                    {artist.name}
                  </a>
                ) : (
                  <span class="artist-name">{artist.name}</span>
                )}
                <span class="artist-count">{artist.count} plays</span>
              </div>
              <div class="artist-bar-container">
                <div class="artist-bar" style={`width: ${barWidth}%`}></div>
              </div>
            </div>
          );
        })}
      </div>
    </section>

    <!-- Top Genres -->
    <section class="mb-10">
      <h2 class="section-title">
        <span class="section-icon">&#127926;</span>
        Top Genres
      </h2>
      <p class="text-wiki-text-muted text-sm mb-4">
        Most common genres in WWOZ playlists
      </p>

      <div class="genre-cloud">
        {topGenres.map(([genre, count]) => {
          // Scale font size based on count
          const scale = 0.8 + (count / maxGenreCount) * 0.6;
          return (
            <a
              href={`/genres/${toGenreSlug(genre)}`}
              class="genre-tag"
              style={`font-size: ${scale}rem`}
            >
              {genre}
              <span class="genre-count">{count}</span>
            </a>
          );
        })}
      </div>
    </section>

    <!-- Top Shows -->
    <section class="mb-10">
      <h2 class="section-title">
        <span class="section-icon">&#128251;</span>
        Top Shows
      </h2>
      <p class="text-wiki-text-muted text-sm mb-4">
        WWOZ programs with the most tracked songs
      </p>

      <div class="shows-grid">
        {topShows.map((show) => (
          <div class="show-card">
            <span class="show-icon">&#127908;</span>
            <h3 class="show-name">{show.name}</h3>
            <p class="show-tracks">
              {show.trackCount.toLocaleString()} tracks
            </p>
          </div>
        ))}
      </div>
    </section>

    <!-- Artist Match Stats -->
    <section class="mb-6">
      <h2 class="section-title">
        <span class="section-icon">&#128279;</span>
        Wiki Coverage
      </h2>
      <p class="text-wiki-text-muted text-sm mb-4">
        How many WWOZ artists are in our wiki
      </p>

      <div class="coverage-stats">
        <div class="coverage-bar">
          <div
            class="coverage-fill"
            style={`width: ${topArtists.filter(a => a.slug).length / topArtists.length * 100}%`}
          ></div>
        </div>
        <p class="coverage-text">
          <strong>{topArtists.filter(a => a.slug).length}</strong> of the top {topArtists.length} artists
          ({((topArtists.filter(a => a.slug).length / topArtists.length) * 100).toFixed(0)}%) have wiki profiles
        </p>
      </div>
    </section>
  </div>
</Layout>

<style>
  /* Stats Grid */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }

  @media (min-width: 640px) {
    .stats-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (min-width: 1024px) {
    .stats-grid {
      grid-template-columns: repeat(5, 1fr);
    }
  }

  .stat-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1.25rem 1rem;
    background: var(--color-bg);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-lg);
    text-align: center;
    transition: all var(--duration-fast) var(--ease-smooth);
  }

  .stat-card:hover {
    border-color: var(--jazz-amber);
    transform: translateY(-2px);
  }

  .stat-icon {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
  }

  .stat-value {
    font-family: 'Playfair Display Variable', Georgia, serif;
    font-size: 1.75rem;
    font-weight: 600;
    color: var(--color-text-heading);
    background: linear-gradient(135deg, var(--color-text-heading) 0%, var(--jazz-amber) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .stat-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-text-muted);
    margin-top: 0.25rem;
  }

  /* Section Titles */
  .section-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-family: 'Playfair Display Variable', Georgia, serif;
    font-size: 1.5rem;
    font-weight: 500;
    color: var(--color-text-heading);
    border-bottom: 1px solid var(--color-border);
    padding-bottom: 0.5rem;
    margin-bottom: 0.5rem;
  }

  .section-icon {
    font-size: 1.25rem;
  }

  /* Artist Chart */
  .artist-chart {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .artist-row {
    display: grid;
    grid-template-columns: 2rem 1fr 40%;
    gap: 0.75rem;
    align-items: center;
    padding: 0.5rem 0.75rem;
    background: var(--color-bg);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
    transition: all var(--duration-fast) var(--ease-smooth);
  }

  .artist-row:hover {
    border-color: var(--color-link);
    background: var(--color-accent-light);
  }

  .artist-rank {
    font-family: 'JetBrains Mono Variable', monospace;
    font-size: 0.75rem;
    color: var(--color-text-muted);
    text-align: center;
  }

  .artist-info {
    display: flex;
    flex-direction: column;
    min-width: 0;
  }

  .artist-name {
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: var(--color-text);
  }

  .artist-name.wiki-link {
    color: var(--color-link);
  }

  .artist-count {
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }

  .artist-bar-container {
    height: 0.5rem;
    background: var(--color-border-light);
    border-radius: 9999px;
    overflow: hidden;
  }

  .artist-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--jazz-amber), var(--electric-cyan));
    border-radius: 9999px;
    transition: width var(--duration-normal) var(--ease-jazz);
  }

  @media (max-width: 640px) {
    .artist-row {
      grid-template-columns: 2rem 1fr;
    }

    .artist-bar-container {
      display: none;
    }
  }

  /* Genre Cloud */
  .genre-cloud {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    align-items: center;
  }

  .genre-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--color-bg);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-lg);
    color: var(--color-link);
    text-decoration: none;
    transition: all var(--duration-fast) var(--ease-smooth);
  }

  .genre-tag:hover {
    border-color: var(--jazz-amber);
    background: var(--color-accent-light);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .genre-count {
    font-family: 'JetBrains Mono Variable', monospace;
    font-size: 0.75em;
    padding: 0.125rem 0.375rem;
    background: var(--color-bg-nav);
    border-radius: var(--radius-sm);
    color: var(--color-text-muted);
  }

  /* Shows Grid */
  .shows-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 1rem;
  }

  .show-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1.25rem;
    background: var(--color-bg);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-lg);
    text-align: center;
    transition: all var(--duration-fast) var(--ease-smooth);
  }

  .show-card:hover {
    border-color: var(--jazz-amber);
    transform: translateY(-2px);
  }

  .show-icon {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
  }

  .show-name {
    font-family: 'Playfair Display Variable', Georgia, serif;
    font-size: 1rem;
    font-weight: 500;
    color: var(--color-text-heading);
    margin: 0 0 0.25rem 0;
    line-height: 1.3;
  }

  .show-tracks {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin: 0;
  }

  /* Coverage Stats */
  .coverage-stats {
    padding: 1.25rem;
    background: var(--color-bg);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-lg);
  }

  .coverage-bar {
    height: 1rem;
    background: var(--color-border-light);
    border-radius: 9999px;
    overflow: hidden;
    margin-bottom: 1rem;
  }

  .coverage-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--jazz-amber), var(--electric-cyan));
    border-radius: 9999px;
    transition: width var(--duration-normal) var(--ease-jazz);
  }

  .coverage-text {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    margin: 0;
    text-align: center;
  }

  /* Dark mode adjustments */
  :global([data-mode="dark"]) .stat-card,
  :global([data-mode="dark"]) .artist-row,
  :global([data-mode="dark"]) .genre-tag,
  :global([data-mode="dark"]) .show-card,
  :global([data-mode="dark"]) .coverage-stats {
    background: var(--jazz-smoke);
  }

  :global([data-mode="dark"]) .stat-value {
    background: linear-gradient(135deg, var(--jazz-cream) 0%, var(--jazz-amber) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
</style>
