---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const allArtists = await getCollection('artists');

  // Collect all unique genres
  const genreSet = new Set<string>();
  allArtists.forEach(artist => {
    const genres = artist.data.genres as string[] | undefined;
    genres?.forEach(genre => genreSet.add(genre));
  });

  // Helper to create slug
  const toSlug = (text: string) => text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');

  // Create a path for each genre
  return Array.from(genreSet).map(genre => ({
    params: { genre: toSlug(genre) },
    props: { genreName: genre },
  }));
}

interface Props {
  genreName: string;
}

const { genreName } = Astro.props;

// Get all artists in this genre
const allArtists = await getCollection('artists');
const genreArtists = allArtists.filter(artist => {
  const genres = artist.data.genres as string[] | undefined;
  return genres?.includes(genreName);
});

// Sort by Spotify popularity (if available), then alphabetically
const sortedArtists = genreArtists.sort((a, b) => {
  const popA = (a.data.spotify_data as { popularity?: number } | undefined)?.popularity || 0;
  const popB = (b.data.spotify_data as { popularity?: number } | undefined)?.popularity || 0;
  if (popB !== popA) return popB - popA;
  const titleA = (a.data.title as string || a.id).toLowerCase();
  const titleB = (b.data.title as string || b.id).toLowerCase();
  return titleA.localeCompare(titleB);
});

// Get related genres (genres that appear with this genre)
const relatedGenreCounts = new Map<string, number>();
genreArtists.forEach(artist => {
  const genres = artist.data.genres as string[] | undefined;
  genres?.forEach(g => {
    if (g !== genreName) {
      relatedGenreCounts.set(g, (relatedGenreCounts.get(g) || 0) + 1);
    }
  });
});
const relatedGenres = Array.from(relatedGenreCounts.entries())
  .sort((a, b) => b[1] - a[1])
  .slice(0, 10);

// Get common instruments in this genre
const instrumentCounts = new Map<string, number>();
genreArtists.forEach(artist => {
  const instruments = artist.data.instruments as string[] | undefined;
  instruments?.forEach(instrument => {
    instrumentCounts.set(instrument, (instrumentCounts.get(instrument) || 0) + 1);
  });
});
const topInstruments = Array.from(instrumentCounts.entries())
  .sort((a, b) => b[1] - a[1])
  .slice(0, 8);

// Helper to create slug
const toSlug = (text: string) => text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');

// Get era distribution
const eraCounts = new Map<string, number>();
genreArtists.forEach(artist => {
  const yearsActive = artist.data.years_active as string | undefined;
  if (yearsActive) {
    const match = yearsActive.match(/(\d{4})/);
    if (match) {
      const decade = Math.floor(parseInt(match[1]) / 10) * 10;
      const era = `${decade}s`;
      eraCounts.set(era, (eraCounts.get(era) || 0) + 1);
    }
  }
});
const sortedEras = Array.from(eraCounts.entries())
  .sort((a, b) => a[0].localeCompare(b[0]));

// Stats
const avgPopularity = Math.round(
  genreArtists
    .filter(a => (a.data.spotify_data as { popularity?: number } | undefined)?.popularity)
    .reduce((sum, a) => sum + ((a.data.spotify_data as { popularity?: number })?.popularity || 0), 0) /
  genreArtists.filter(a => (a.data.spotify_data as { popularity?: number } | undefined)?.popularity).length || 0
);
---

<Layout title={genreName}>
  <div class="article-content">
    <h1>{genreName}</h1>

    <p class="text-wiki-text-secondary mb-6">
      <strong>{genreArtists.length.toLocaleString()}</strong> artists in this genre.
      {avgPopularity > 0 && (
        <> Average Spotify popularity: <strong>{avgPopularity}/100</strong>.</>
      )}
    </p>

    <!-- Genre Stats -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
      <!-- Related Genres -->
      {relatedGenres.length > 0 && (
        <div class="bg-wiki-bg border border-wiki-border rounded p-4">
          <h3 class="font-semibold mb-2 text-wiki-text">Related Genres</h3>
          <div class="flex flex-wrap gap-1">
            {relatedGenres.map(([genre, count]) => (
              <a
                href={`/genres/${toSlug(genre)}`}
                class="inline-flex items-center px-2 py-1 bg-wiki-tag-bg border border-wiki-tag-border rounded text-xs hover:bg-wiki-accent-light transition-colors"
              >
                <span class="text-wiki-link">{genre}</span>
                <span class="ml-1 text-wiki-text-muted">({count})</span>
              </a>
            ))}
          </div>
        </div>
      )}

      <!-- Top Instruments -->
      {topInstruments.length > 0 && (
        <div class="bg-wiki-bg border border-wiki-border rounded p-4">
          <h3 class="font-semibold mb-2 text-wiki-text">Common Instruments</h3>
          <div class="flex flex-wrap gap-1">
            {topInstruments.map(([instrument, count]) => (
              <a
                href={`/instruments/${toSlug(instrument)}`}
                class="inline-flex items-center px-2 py-1 bg-wiki-tag-bg border border-wiki-tag-border rounded text-xs hover:bg-wiki-accent-light transition-colors"
              >
                <span class="text-wiki-link">{instrument}</span>
                <span class="ml-1 text-wiki-text-muted">({count})</span>
              </a>
            ))}
          </div>
        </div>
      )}
    </div>

    <!-- Era Distribution -->
    {sortedEras.length > 0 && (
      <div class="bg-wiki-bg border border-wiki-border rounded p-4 mb-8">
        <h3 class="font-semibold mb-3 text-wiki-text">Activity by Era</h3>
        <div class="flex flex-wrap gap-2">
          {sortedEras.map(([era, count]) => (
            <span class="inline-flex items-center px-2 py-1 bg-white border border-wiki-border-light rounded text-sm">
              <span class="font-medium">{era}</span>
              <span class="ml-1 text-wiki-text-muted text-xs">({count})</span>
            </span>
          ))}
        </div>
      </div>
    )}

    <!-- Artists List -->
    <h2>Artists ({genreArtists.length})</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
      {sortedArtists.map(artist => {
        const spotifyData = artist.data.spotify_data as { popularity?: number; followers?: number } | undefined;
        const otherGenres = (artist.data.genres as string[] | undefined)?.filter(g => g !== genreName).slice(0, 2) || [];

        return (
          <a
            href={`/artists/${artist.id}`}
            class="block p-3 bg-wiki-bg border border-wiki-border-light rounded hover:border-wiki-link hover:bg-wiki-accent-light transition-colors"
          >
            <div class="flex items-start justify-between">
              <span class="text-wiki-link font-medium">{artist.data.title || artist.id}</span>
              {spotifyData?.popularity && (
                <span class="text-xs bg-green-100 text-green-700 px-1.5 py-0.5 rounded">
                  {spotifyData.popularity}
                </span>
              )}
            </div>
            {otherGenres.length > 0 && (
              <div class="text-xs text-wiki-text-muted mt-1 truncate">
                Also: {otherGenres.join(', ')}
              </div>
            )}
            {artist.data.years_active && (
              <div class="text-xs text-wiki-text-muted mt-0.5">
                {artist.data.years_active}
              </div>
            )}
          </a>
        );
      })}
    </div>

    <!-- Back Link -->
    <div class="mt-8 pt-4 border-t border-wiki-border">
      <a href="/genres" class="text-wiki-link hover:underline">
        &larr; Back to all genres
      </a>
    </div>
  </div>
</Layout>
